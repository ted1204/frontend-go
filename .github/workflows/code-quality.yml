name: Code Quality & Optimization

on:
  pull_request:
    branches: [ main, develop, dev ]
  push:
    branches: [ main, develop, dev ]

jobs:
  file-size-check:
    name: Check File Size Compliance (200 lines limit)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Check file line count compliance
        run: |
          echo "Checking for files exceeding 200 lines..."
          violations=0
          
          find src -type f \( -name "*.tsx" -o -name "*.ts" \) -exec bash -c '
            lines=$(wc -l < "$1")
            # Subtract blank lines (approximate)
            if [ $lines -gt 200 ]; then
              echo "Violation: $1 has $lines lines ($(($lines - 200)) over limit)"
              ((violations++))
            fi
          ' _ {} \; 2>/dev/null || true
          
          if [ "$violations" -gt 0 ]; then
            echo ""
            echo "Found files exceeding 200 line limit."
            echo "Please refactor the following files:"
            find src -type f \( -name "*.tsx" -o -name "*.ts" \) -exec bash -c '
              lines=$(wc -l < "$1")
              if [ $lines -gt 200 ]; then
                echo "  - $1 ($lines lines)"
              fi
            ' _ {} \; 2>/dev/null | sort -V
            echo ""
            echo "Refactoring strategies:"
            echo "  1. Extract custom hooks"
            echo "  2. Create sub-components"
            echo "  3. Move logic to services"
            echo "  4. Separate concerns into different files"
            exit 0  # Warning, not failure for now
          else
            echo "All files comply with 200 line limit."
          fi

  no-hardcoded-strings:
    name: Check for Hardcoded Strings
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for hardcoded Chinese/English strings in components
        run: |
          echo "Checking for potential hardcoded strings..."
          # This is a basic check - flags potential issues for review
          echo "Manual review recommended for user-facing text."

  imports-organization:
    name: Validate Imports Organization
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Check imports are properly organized
        run: |
          echo "Validating import organization..."
          echo "Import order should be:"
          echo "  1. React/external libraries"
          echo "  2. Monorepo packages (@nthucscc/*)"
          echo "  3. Core imports (@/core)"
          echo "  4. Feature imports (@/features)"
          echo "  5. Shared imports (@/shared)"
          echo "  6. Local relative imports"
          echo "  7. CSS imports (last)"

  circular-dependencies:
    name: Detect Circular Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for circular dependencies
        run: |
          # This is optional - requires madge or similar tool
          echo "Consider installing 'madge' for circular dependency detection."
          echo "  npm install --save-dev madge"
          echo "  madge --extensions ts,tsx src/"
        continue-on-error: true

  component-structure:
    name: Validate Component Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check component structure compliance
        run: |
          echo "Validating component structure..."
          echo ""
          echo "Components should follow this pattern:"
          echo "  1. Import statements"
          echo "  2. Type/Interface definitions"
          echo "  3. Component implementation"
          echo "  4. Hook usage (within component)"
          echo "  5. Effect handling"
          echo "  6. Event handlers"
          echo "  7. Render/return statement"
          echo "  8. Export statement"
          echo ""
          echo "Files exceeding structure guidelines:"
          find src/features -name "*.tsx" -type f | head -5 | while read f; do
            echo "  - Review: $f"
          done

  i18n-validation:
    name: Validate i18n Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate i18n translations
        run: npm run check:i18n || echo "i18n check script not configured yet."
        continue-on-error: true

      - name: Verify default language is Chinese
        run: |
          echo "Checking default language configuration..."
          if grep -r "DEFAULT_LANGUAGE.*zh\|default.*'zh'" packages/utils/src/i18n/ src/core/context/ 2>/dev/null; then
            echo "Default language is set to Chinese (zh)."
          else
            echo "Verify default language configuration."
          fi
        continue-on-error: true

  theme-validation:
    name: Validate Dark Mode Theme Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check tailwind dark mode config
        run: |
          echo "Validating Tailwind dark mode configuration..."
          if grep -q "darkMode.*class" tailwind.config.js; then
            echo "Dark mode is configured with 'class' strategy."
          else
            echo "Verify Tailwind dark mode configuration."
            echo "  Required: darkMode: 'class' in tailwind.config.js"
          fi
        continue-on-error: true

      - name: Check theme context exists
        run: |
          if [ -f "src/core/context/ThemeContext.tsx" ] && [ -f "packages/utils/src/context/ThemeContext.tsx" ]; then
            echo "Theme context files are properly located."
          else
            echo "Check theme context file locations."
          fi
        continue-on-error: true

  production-ready:
    name: Production Readiness Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for console.log statements
        run: |
          echo "Scanning for console statements in production code..."
          count=$(grep -r "console\\.log\|console\\.debug" src --include="*.ts" --include="*.tsx" | grep -v "test\|spec" | wc -l)
          if [ $count -gt 0 ]; then
            echo "Found $count console statements in production code."
            grep -r "console\\.log\|console\\.debug" src --include="*.ts" --include="*.tsx" | grep -v "test\|spec" | head -10
          else
            echo "No console statements found in production code."
          fi
        continue-on-error: true

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for unresolved TODOs and FIXMEs..."
          count=$(grep -r "TODO\|FIXME" src --include="*.ts" --include="*.tsx" | wc -l)
          if [ $count -gt 0 ]; then
            echo "Found $count TODO/FIXME comments:"
            grep -r "TODO\|FIXME" src --include="*.ts" --include="*.tsx" | head -5
          else
            echo "No outstanding TODOs or FIXMEs."
          fi
        continue-on-error: true

      - name: Verify package.json scripts
        run: |
          echo "Verifying required npm scripts..."
          required_scripts=("lint" "format" "type-check" "build" "test")
          for script in "${required_scripts[@]}"; do
            if grep -q "\"$script\"" package.json; then
              echo "Script '$script' is defined."
            else
              echo "Missing script: '$script'."
            fi
          done
        continue-on-error: true

summary:
  name: Code Quality Summary
  runs-on: ubuntu-latest
  if: always()
  needs: [
    file-size-check,
    no-hardcoded-strings,
    imports-organization,
    component-structure,
    i18n-validation,
    theme-validation,
    production-ready
  ]
  
  steps:
    - name: Summary
      run: |
        echo "## Code Quality Check Summary"
        echo ""
        echo "All code quality checks have been reviewed."
        echo "Please address any warnings marked in the logs."
        echo ""
        echo "For details, see the job logs above."
